<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  #map {
    height: 80%;
    width: 100%;
  }
  #locdetails {
    position: absolute;
    right: 300px;
    text-align: center;
    font-family: Roboto, Arial, sans-serif;
    font-size: 13px;
    z-index: 5;
    box-shadow: rgb(51, 51, 51) 0px 4px 6px -4px;
    padding: 5px 10px;
    background: linear-gradient(rgb(255, 255, 255) 0%, rgb(245, 245, 245) 100%);
    border: rgb(229, 229, 229) 1px solid;
    margin-top: 50px;
  }
</style>

<div class="content-wrapper">
  <div class="content-heading">
    <h2>HeatMaps - Real Time Intel</h2>   <br />
    <b> View Species</b> 
    <%= form_tag species_filter_path, id: 'species_form' do %>
      <select name="species" class="form-control m-b" id="species_select">
        <option value="Any">Any</option>
        <% all_species.each do |species| %>
          <option value="<%= species.html_safe %>"><%= species %></option>
        <% end %>
      </select>
    <% end %> 
  </div>
  <div id="locdetails" style="display:none;">
    <p>Test</p>
  </div> 
<div class="row">
  <div class="col-md-">        
    <div class="panel panel-default">
      <div class="panel-heading"></div>
        <div class="panel-body">
          <div style="height:700px; width: 1350px;">
            <div id="map" class="gmap">
              <p id="notice"><%= notice %></p>
            </div> 
          </div>
        </div>
      </div> 
    </div>     
  </div> 
</div> 


<script>

  var map;
  var infoWindow;       
      
    // Map Display options
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 9,
        center: {lat: 42.05, lng: -70.25},
        mapTypeId: google.maps.MapTypeId.SATELLITE
      });
      var polygons = [];
      $.ajax({
          url: '<%= species_filter_path %>',
          type: "get", //send it through get method
          data:{target_species:$('#species_select').val()},
          success: function(response) {
            //Do Something
            console.log(response);
            for (var i = 0; i < response.length ; i++) {
              polygons.push(new google.maps.Polygon({
              paths: response[i].cfile,
              strokeColor: '#F7F8FF',
              strokeOpacity: 0.8,
              strokeWeight: 1,
              fillColor: response[i].color,
              fillOpacity: 0.45,
              editable: false,  
              map: map,
              loc: response[i].location,
              rep: response[i].reports,
              mavg: response[i].movingavg
            }));
              polygons[polygons.length-1].setMap(map);
              var p = polygons[i];
               google.maps.event.addListener(p, 'click', function (event) {
                console.log(this);
        // console.log(location_reports);               
         var contentString = '<table><thead><tr><th>Date</th><th>Target Species</th><th>Vessel Name</th><th>Primary Method</th><th>Catch Total</th><th>Trip Summary</th></tr></thead><tbody><b>' + this.loc.short_name +'</b> <br>' + this.loc.long_name +'<br> <br>';
         for(var j=0;j<this.rep.length; j++){
          contentString += '<tr><td>' +this.rep[j].rep.date + '</td> <td>' +this.rep[j].rep.target_species + '</td><td>' +this.rep[j].vessel_name + '</td><td>' +this.rep[j].rep.primary_method + '</td><td>' +this.rep[j].rep.catch_total + '</td><td>' +this.rep[j].rep.trip_summary + '</td></tr>';
         };
         contentString +='</tbody></table>';
        // Replace the info window's content and position.
        infoWindow = new google.maps.InfoWindow;
        infoWindow.setContent(contentString);
        infoWindow.setPosition(event.latLng);
        infoWindow.open(map);
              }); 

              google.maps.event.addListener(p, 'mouseover',function (event){
                $("#locdetails").css("display", "block");
                $( "#locdetails" ).append( "<p>"+ this.loc.short_name +"</p>" +"<p>" + this.mavg +  "</p>" );
                map.data.revertStyle();
        this.setOptions({
          strokeColor: '#F7F8FF',
          strokeWeight: 3 ,
          fillOpacity: 0.75
            });
              });
              google.maps.event.addListener(p, 'mouseout',function (event){
                $("#locdetails").css("display", "none");
                $( "#locdetails" ).empty();
              map.data.revertStyle();
          this.setOptions({
              strokeColor: '#F7F8FF',
            strokeOpacity: 0.8,
            strokeWeight: 1,
            fillOpacity: 0.45,
          });
              });
            };

          },
          error: function(xhr) {
            //Do Something to handle error
          }
        });
    

 }


 $('#species_select').change(function(){
  infoWindow.close();
initMap();

  // $.get(
  //   '<%= species_filter_path %>',
  //   $('#species_select').val(),
  //   function(data){
  //     console.log(map);
  //     console.log($('#species_select').val());
  //     infoWindow.close();
  //     // map.fitBounds(bounds);
  //   }
  // );

});
</script>
      
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDRhKrHEYhZA2Qg5fagbEKaUItVsB-cQ3g&callback=initMap">
</script>




